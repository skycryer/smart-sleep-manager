# üåô Smart Sleep Manager for Unraid

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Unraid](https://img.shields.io/badge/Unraid-6.12%2B-orange.svg)](https://unraid.net)
[![GitHub release](https://img.shields.io/github/release/skycryer/smart-sleep-manager.svg)](https://github.com/skycryer/smart-sleep-manager/releases)
[![GitHub issues](https://img.shields.io/github/issues/skycryer/smart-sleep-manager.svg)](https://github.com/skycryer/smart-sleep-manager/issues)

An intelligent automated sleep management plugin for Unraid servers with array disk monitoring, network activity detection, and Telegram notifications.

## ‚ú® Features

üõå **Intelligent Sleep Management**
- Monitors array disk activity (standby/spindown detection)
- Network traffic monitoring with configurable thresholds
- Configurable idle time before sleep activation
- Distinguishes between array disks and cache/docker/parity drives

üì± **Telegram Integration**
- Real-time notifications for sleep events
- Configurable notification types (standby timer, sleep activation, blocked sleep)
- Test function built into web interface
- Markdown-formatted messages with server information

üéõÔ∏è **Web-Based Configuration**
- Complete settings management through Unraid web interface
- Auto-detection of available disks and network interfaces
- Input validation and real-time testing
- No command-line configuration required

üîß **Advanced Power Management**
- Dynamix S3 Sleep compatibility (recommended method)
- Alternative systemctl suspend support
- Automatic Wake-on-LAN configuration
- Post-wake Samba restart for SMB share reliability
- Optional gigabit speed forcing and DHCP renewal

‚è∞ **Automated Scheduling**
- Runs every 5 minutes via cron job
- Automatic cron job management (install/uninstall)
- Manual sleep check function for testing
- Comprehensive logging for troubleshooting

## üìã Requirements

- **Unraid**: Version 6.12.0 or higher
- **Hardware**: S3 sleep-capable motherboard/BIOS
- **Network**: Wake-on-LAN compatible network interface
- **Optional**: Telegram account for notifications

## üöÄ Quick Start

### 1. Installation

**Method A: Direct Plugin Installation**
```bash
# Download and install via Unraid Web UI
# Apps > Install Plugin > Plugin File URL:
https://raw.githubusercontent.com/skycryer/smart-sleep-manager/main/smart.sleep.manager.plg
```

**Method B: Manual Download**
```bash
# Download the plugin file and install via web interface
wget https://github.com/skycryer/smart-sleep-manager/releases/latest/download/smart.sleep.manager.plg
# Then: Apps > Install Plugin > Choose File
```

### 2. Basic Configuration

1. Navigate to **Settings > Smart Sleep Manager**
2. **Enable** the plugin
3. Set **Array Disks** to monitor: `sdb sdc sdd sde` (your array disks)
4. Set **Ignore Disks**: `cache1 cache2 parity1` (cache/docker/parity)
5. Configure **Idle Time**: `15` minutes (default)
6. Click **Apply**

### 3. Telegram Setup (Optional)

1. Message [@BotFather](https://t.me/BotFather) in Telegram
2. Create new bot: `/newbot`
3. Copy the **Bot Token**
4. Send a message to your bot
5. Get your **Chat ID**: `https://api.telegram.org/botTOKEN/getUpdates`
6. Enter both in plugin settings and click **Test Telegram**

## ‚öôÔ∏è Configuration Guide

### Array Disk Monitoring

```bash
# Example configuration for typical Unraid setup
Array Disks: "sdb sdc sdd sde sdf sdg"     # Data disks only
Ignore Disks: "sda cache1 parity1 nvme0n1" # Cache, parity, system drives
```

### Network Monitoring

```bash
Network Interface: "eth0"           # Usually eth0 or br0
Network Threshold: "102400"         # 100 KB/s in bytes
Monitoring: "Enabled"               # Enable network activity checks
```

### Sleep Settings

```bash
Sleep Method: "Dynamix S3"          # Recommended (compatible with original)
WOL Options: "g"                    # MagicPacket support
Restart Samba: "Enabled"            # Ensures SMB shares work after wake
```

## üìä Monitoring & Logging

### Real-time Monitoring
```bash
# Watch live log output
tail -f /tmp/smart-sleep.log

# Check current configuration
cat /boot/config/plugins/smart.sleep.manager/smart.sleep.manager.cfg

# Manual sleep check
/usr/local/emhttp/plugins/smart.sleep.manager/scripts/smart_sleep.sh
```

### Telegram Notifications

The plugin sends formatted notifications for:

- **‚è≥ Standby Timer Started**: When all conditions are met and countdown begins
- **üåô Sleep Activated**: When server actually goes to sleep
- **üí§ Sleep Blocked**: When active disks or network traffic prevent sleep (optional)

## üõ†Ô∏è Troubleshooting

### Sleep Not Working

1. **Check Hardware Support**
   ```bash
   # Verify S3 sleep support
   dmesg | grep -i "acpi.*sleep"
   cat /sys/power/state
   ```

2. **Verify Wake-on-LAN**
   ```bash
   # Check WOL settings
   ethtool eth0 | grep Wake-on
   # Should show: Wake-on: g
   ```

3. **Check Array Status**
   ```bash
   # All disks should show "standby" or "sleeping"
   hdparm -C /dev/sd[bcdefgh]
   ```

### Network Issues After Wake

- Enable **Force Gigabit** in advanced settings
- Enable **DHCP Renewal** if using DHCP
- Check **Samba Restart** is enabled

### Telegram Not Working

1. **Verify Bot Token Format**: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`
2. **Check Chat ID**: Should be numeric (can be negative for groups)
3. **Test Network**: Use the built-in test function
4. **Check Logs**: `/tmp/smart-sleep.log` shows Telegram attempts

## üìÅ Project Structure

```
smart-sleep-manager/
‚îú‚îÄ‚îÄ üìÑ smart.sleep.manager.plg      # Plugin installer
‚îú‚îÄ‚îÄ üìÑ SmartSleepSettings.page      # Web UI configuration
‚îú‚îÄ‚îÄ üìÑ SleepManager.php             # Manual sleep button
‚îú‚îÄ‚îÄ üìÑ default.cfg                  # Default settings
‚îú‚îÄ‚îÄ üìÅ include/
‚îÇ   ‚îú‚îÄ‚îÄ update.sleep.php            # Configuration handler
‚îÇ   ‚îú‚îÄ‚îÄ SleepMode.php               # Manual sleep execution
‚îÇ   ‚îî‚îÄ‚îÄ test_telegram.php           # Telegram test handler
‚îî‚îÄ‚îÄ üìÅ scripts/
    ‚îú‚îÄ‚îÄ smart_sleep.sh              # Main sleep logic script
    ‚îú‚îÄ‚îÄ preRun                      # Pre-sleep hooks
    ‚îî‚îÄ‚îÄ postRun                     # Post-wake hooks
```

## ü§ù Contributing

We welcome contributions! Please:

1. **Fork** the repository
2. **Create** a feature branch: `git checkout -b feature/amazing-feature`
3. **Commit** your changes: `git commit -m 'Add amazing feature'`
4. **Push** to the branch: `git push origin feature/amazing-feature`
5. **Open** a Pull Request

### Development Setup

```bash
# Clone the repository
git clone https://github.com/skycryer/smart-sleep-manager.git
cd smart-sleep-manager

# Test on your Unraid server
scp smart.sleep.manager.plg root@unraid-server:/tmp/
ssh root@unraid-server "/usr/local/sbin/plugin install /tmp/smart.sleep.manager.plg"
```

## üìû Support

- **üìñ Documentation**: [Wiki](https://github.com/skycryer/smart-sleep-manager/wiki)
- **üêõ Bug Reports**: [GitHub Issues](https://github.com/skycryer/smart-sleep-manager/issues)
- **üí¨ Community**: [Unraid Forums](https://forums.unraid.net)
- **üìß Contact**: [GitHub Discussions](https://github.com/skycryer/smart-sleep-manager/discussions)

## üìÑ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## üôè Acknowledgments

- **Bergware International** for the original Dynamix S3 Sleep plugin inspiration
- **Lime Technology** for the amazing Unraid platform
- **The Unraid Community** for continuous support and feedback
- **Original sleepy.sh contributors** for the foundational automation concepts

---

**Made with ‚ù§Ô∏è for the Unraid Community**

*Save power, stay connected, sleep smart! üåô*

## üåü Features

- **Automatisches Sleep-Management**: √úberwacht Array-Disks und Netzwerk-Aktivit√§t
- **Telegram-Benachrichtigungen**: Erhalte Updates √ºber Sleep-Ereignisse
- **Web-UI Konfiguration**: Einfache Einrichtung √ºber die Unraid-Weboberfl√§che
- **Dynamix S3 Sleep Kompatibilit√§t**: Verwendet bew√§hrte Sleep-Methoden
- **Intelligent Monitoring**: Unterscheidet zwischen Array- und Cache/Docker-Disks
- **Anpassbare Thresholds**: Konfiguriere Netzwerk- und Zeit-Limits
- **Wake-on-LAN Support**: Automatische WOL-Konfiguration vor Sleep

## üìã Systemanforderungen

- Unraid 6.12.0 oder h√∂her
- S3 Sleep-f√§hige Hardware
- Wake-on-LAN kompatible Netzwerkkarte
- Optional: Telegram-Bot f√ºr Benachrichtigungen

## üöÄ Installation

1. **Plugin installieren:**
   - Lade die `.plg` Datei in Unraid hoch (Apps > Install Plugin)
   - Oder f√ºge die Plugin-URL zu Community Applications hinzu

2. **Grundkonfiguration:**
   - Gehe zu Settings > Smart Sleep Manager
   - W√§hle Array-Disks zum √úberwachen aus
   - Setze Ignore-Disks (Cache, Docker, Parity)
   - Konfiguriere Idle-Zeit (Standard: 15 Minuten)

3. **Optional - Telegram einrichten:**
   - Erstelle einen Bot mit @BotFather
   - Kopiere Bot-Token und Chat-ID
   - Teste die Konfiguration √ºber die Web-UI

## ‚öôÔ∏è Konfiguration

### Array-Disk √úberwachung
- **Array Disks**: W√§hle die zu √ºberwachenden Array-Disks
- **Ignore Disks**: Cache-, Docker- und Parity-Disks ausschlie√üen
- **Idle Time**: Zeit in Minuten ohne Disk-Aktivit√§t vor Sleep

### Netzwerk-√úberwachung
- **Network Interface**: Meist eth0 oder br0
- **Threshold**: Netzwerk-Traffic-Limit in Bytes/Sekunde
- **Monitoring**: Aktiviert/Deaktiviert Netzwerk-Checks

### Telegram-Benachrichtigungen
- **Bot Token**: Von @BotFather erhalten
- **Chat ID**: Eigene Telegram User-ID
- **Benachrichtigungstypen**: Timer-Start, Sleep, Blockierung

## üîß Erweiterte Einstellungen

- **Sleep Method**: Dynamix S3 (empfohlen) oder systemctl suspend
- **WOL Options**: Wake-on-LAN Konfiguration (meist 'g')
- **Samba Restart**: Automatischer Samba-Neustart nach Wake-up
- **Gigabit Force**: Netzwerk-Geschwindigkeit nach Wake erzwingen
- **DHCP Renewal**: DHCP-Lease nach Wake erneuern

## üìä Monitoring

### Log-Datei
```bash
tail -f /tmp/smart-sleep.log
```

### Manueller Test
- Web-UI: "Run Sleep Check Now" Button
- Terminal: `/usr/local/emhttp/plugins/smart.sleep.manager/scripts/smart_sleep.sh`

### Cron-Job
Das Plugin f√ºhrt alle 5 Minuten einen Check aus:
```
*/5 * * * * /usr/local/emhttp/plugins/smart.sleep.manager/scripts/smart_sleep.sh
```

## üõ†Ô∏è Troubleshooting

### Sleep funktioniert nicht
1. Pr√ºfe Hardware S3-Support: `dmesg | grep -i "acpi.*sleep"`
2. Teste Wake-on-LAN: `ethtool eth0 | grep Wake-on`
3. √úberpr√ºfe Array-Status: Alle Disks m√ºssen im Standby sein
4. Kontrolliere Log-Datei: `/tmp/smart-sleep.log`

### Netzwerk-Probleme nach Wake
1. Aktiviere "Force Gigabit"
2. Bei DHCP: Aktiviere "DHCP Renewal"
3. √úberpr√ºfe Samba-Restart

### Telegram funktioniert nicht
1. Pr√ºfe Bot-Token Format: `123456789:ABCdefGHIjklMNOpqrsTUVwxyz`
2. Chat-ID finden: `https://api.telegram.org/botTOKEN/getUpdates`
3. Teste √ºber Web-UI "Test Telegram" Button

## üìÅ Dateistruktur

```
/usr/local/emhttp/plugins/smart.sleep.manager/
‚îú‚îÄ‚îÄ SmartSleepSettings.page    # Web-UI Konfiguration
‚îú‚îÄ‚îÄ SleepManager.php           # Manual Sleep Button
‚îú‚îÄ‚îÄ default.cfg                # Standard-Konfiguration
‚îú‚îÄ‚îÄ include/
‚îÇ   ‚îú‚îÄ‚îÄ SleepMode.php         # Sleep-Ausf√ºhrung
‚îÇ   ‚îú‚îÄ‚îÄ update.sleep.php      # Konfigurations-Update
‚îÇ   ‚îî‚îÄ‚îÄ test_telegram.php     # Telegram-Test
‚îî‚îÄ‚îÄ scripts/
    ‚îú‚îÄ‚îÄ smart_sleep.sh        # Haupt-Sleep-Script
    ‚îú‚îÄ‚îÄ preRun                # Pre-Sleep Kommandos
    ‚îî‚îÄ‚îÄ postRun               # Post-Wake Kommandos
```

## üîÑ Deinstallation

Das Plugin kann √ºber Apps > Installed Plugins deinstalliert werden. Die Konfigurationsdateien bleiben in `/boot/config/plugins/smart.sleep.manager/` erhalten.

## üìû Support

- **Log-Datei**: `/tmp/smart-sleep.log`
- **Konfiguration**: `/boot/config/plugins/smart.sleep.manager/smart.sleep.manager.cfg`
- **Unraid Forum**: [Plugin Support Thread]
- **GitHub Issues**: [Repository Issues]

## üìÑ Lizenz

Dieses Plugin ist unter der MIT License lizenziert - siehe die [LICENSE](../LICENSE) Datei f√ºr Details.

Die MIT License erlaubt:
- ‚úÖ Kommerzielle Nutzung
- ‚úÖ Modifikation
- ‚úÖ Weiterverteilung
- ‚úÖ Private Nutzung
- ‚úÖ Patent-Nutzung

## üôè Credits

- Basiert auf Dynamix S3 Sleep Plugin von Bergware International
- Inspiriert von der Unraid Community
- Telegram-Integration f√ºr moderne Benachrichtigungen